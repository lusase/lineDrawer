"use strict";var _slicedToArray=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var i=[],n=!0,o=!1,r=void 0;try{for(var s,a=t[Symbol.iterator]();!(n=(s=a.next()).done)&&(i.push(s.value),!e||i.length!==e);n=!0);}catch(t){o=!0,r=t}finally{try{!n&&a.return&&a.return()}finally{if(o)throw r}}return i}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},_createClass=function(){function n(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,i=Array(t.length);e<t.length;e++)i[e]=t[e];return i}return Array.from(t)}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}!function(t,e){"object"===("undefined"==typeof module?"undefined":_typeof(module))&&"object"===_typeof(module.exports)?module.exports=e(t,require("fabric").fabric):e(t,t.fabric,!0)}("undefined"!=typeof window?window:void 0,function(e,t,i){if(!t)throw new Error("fabric required. please install it by npm or load it by script tag");var u=t.Canvas,n=t.Circle,o=t.Path;function r(){return Array.from({length:8},function(){return Math.floor(65536*(1+Math.random())).toString(16).substr(1)}).join("")}function s(e,i){Object.keys(i).forEach(function(t){e.style[t]=i[t]})}t.Object.prototype.originX=t.Object.prototype.originY="center";_createClass(a,[{key:"on",value:function(t,e){if("function"!=typeof e)throw new Error("method (on) only takes instances of Function");return this._events[t]?this._events[t]=[this._events[t],e]:this._events[t]=e,this}},{key:"off",value:function(t,e){if(!this._events[t])return this;e||delete this._events[t];var i=this._events[t];if(Array.isArray(i)){var n=i.indexOf(e);if(n<0)return this;i.splice(n,1),0===i.length&&delete this._events[t]}else i===e&&delete this._events[t];return this}},{key:"emit",value:function(t){for(var e=this,i=arguments.length,n=Array(1<i?i-1:0),o=1;o<i;o++)n[o-1]=arguments[o];t=this._events[t];return!!t&&("function"==typeof t?(t.call.apply(t,[this].concat(n)),!0):!!Array.isArray(t)&&(t.forEach(function(t){t.call.apply(t,[e].concat(n))}),!0))}},{key:"removeAllListeners",value:function(){return this._events={},this}}]),t=a;function a(){_classCallCheck(this,a),this._events={}}_inherits(d,t),_createClass(d,[{key:"dispose",value:function(){this.canvas.dispose(),e.removeEventListener("keydown",this.onKeydown)}},{key:"insertTooltip",value:function(){var e=this;this.dataSource&&(this.removeTooltipEl(),this.config.alwaysShowTip?this.dataSource.forEach(function(t){return e.insertPathTip(t)}):this.tooltip=this.createTipEl())}},{key:"removeTooltipEl",value:function(){var t=this.canvas.wrapperEl.getElementsByClassName("tooltip");[].concat(_toConsumableArray(t)).forEach(function(t){return t.remove()})}},{key:"insertPathTip",value:function(t){var e,i,n,o;0!==t.strokeWidth&&(t.tooltip=this.createTipEl(),t.tooltip.innerHTML=this.config.formatter(t),i=this.convert([t.dots[0],t.dots[t.dots.length-1]]),n=_slicedToArray(i,2),e=(o=_slicedToArray(n[0],2))[0],i=o[1],n=(o=_slicedToArray(n[1],2))[0],o=o[1],s(t.tooltip,{visibility:"visible",left:(e+n)/2+"px",top:(i+o)/2+"px"}))}},{key:"createTipEl",value:function(){var t=this.canvas.wrapperEl,e=document.createElement("div");return e.className="tooltip",t.appendChild(e),e}},{key:"resize",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e=t.width,t=t.height;void 0!==e&&void 0!==t&&(this.canvas.setDimensions({width:e,height:t}),this.reload())}},{key:"convert",value:function(){var t=this.canvas,e=t.width,i=t.height;return(0<arguments.length&&void 0!==arguments[0]?arguments[0]:[]).map(function(t){return[t[0]*e,t[1]*i]})}},{key:"load",value:function(t){var n=this;t&&t.length&&("string"==typeof t&&(t=JSON.parse(t)),this.dataSource=t,this.lineMap={},t.forEach(function(i){var t=void 0!==i.id?String(i.id):void 0;n.newEmptyLine(t),n.convert(i.dots).forEach(function(t){var e=n.getCurrentLine(),t=n.makeDot(t[0],t[1]);e.dots.push(t),n.renderLines(i)})}),this.config.editable||this.insertTooltip())}},{key:"setConfig",value:function(t){this.config=Object.assign(Object.assign({},this.config),t),this.reload(this.getLinesInfo())}},{key:"reload",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.dataSource;console.log(t),this.canvas.clear(),this.load(t)}},{key:"newEmptyLine",value:function(t){var e=Object.values(this.lineMap).find(function(t){return 0===t.dots.length});e?this.currentLineId=e.id:(t=t||r(),this.lineMap[t]={dots:[],id:t,path:null,idx:Object.keys(this.lineMap).length},this.currentLineId=t,this.emit("add.line",this.lineMap[t]))}},{key:"getLinesInfo",value:function(){var e=this;return Object.values(this.lineMap).sort(function(t,e){return t.idx-e.idx}).map(function(t){return t.path?{id:t.id,selected:t.path.selected,strokeWidth:t.path.strokeWidth,stroke:t.path.stroke,dots:null===(t=t.dots)||void 0===t?void 0:t.map(function(t){return[t.left/e.canvas.width,t.top/e.canvas.height]})}:{}})}},{key:"getCurrentLine",value:function(){return this.lineMap[this.currentLineId]}},{key:"configCurrentPath",value:function(t){var e=this.getCurrentLine().path;e&&(e.set(t),this.renderLines())}},{key:"initListeners",value:function(){this.onObjectMoving=this.onObjectMoving.bind(this),this.onMouseDown=this.onMouseDown.bind(this),this.onMouseOver=this.onMouseOver.bind(this),this.onMouseOut=this.onMouseOut.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onKeydown=this.onKeydown.bind(this);var t={"object:moving":this.onObjectMoving,"mouse:down":this.onMouseDown,"mouse:over":this.onMouseOver,"mouse:out":this.onMouseOut,"mouse:move":this.onMouseMove};this.canvas.on(t),e.addEventListener("keydown",this.onKeydown)}},{key:"showToolTip",value:function(){this.tooltip.style.visibility="visible"}},{key:"hideToolTip",value:function(){this.tooltip.style.visibility="hidden"}},{key:"isToolTipHidden",value:function(){return"hidden"===this.tooltip.style.visibility}},{key:"onKeydown",value:function(t){this.config.editable||("Delete"===t.code?this.delCurrentLine():"KeyZ"===t.code&&t.ctrlKey&&this.delSelectedDot())}},{key:"onMouseMove",value:function(t){this.config.editable||this.tooltip&&!this.isToolTipHidden()&&s(this.tooltip,{left:t.pointer.x+"px",top:t.pointer.y+"px"})}},{key:"onMouseOver",value:function(t){this.config.editable||(t=t.target,!this.config.alwaysShowTip&&t&&"path"===t.name&&(this.showToolTip(),this.tooltip.innerHTML=this.config.formatter(t._data)))}},{key:"onMouseOut",value:function(t){this.config.editable||(t=t.target,!this.config.alwaysShowTip&&t&&"path"===t.name&&this.hideToolTip())}},{key:"onObjectMoving",value:function(t){this.config.editable&&"dot"===t.target.name&&this.renderLines()}},{key:"onMouseDown",value:function(t){var e,i;this.config.editable&&(t.e.ctrlKey&&this.newEmptyLine(),(e=t.target)||(i=this.getCurrentLine(),t=this.makeDot(t.pointer.x,t.pointer.y),i.dots.push(t),this.renderLines(),this.selectDot(t),this.selectCurrentPath()),e&&"dot"===e.name&&(this.currentLineId=e.parentLine.id,this.selectDot(e),this.selectCurrentPath()))}},{key:"selectLine",value:function(t){this.lineMap[t]&&(this.currentLineId=t,this.selectDot(this.getCurrentLine().dots[0]),this.selectCurrentPath(),this.renderLines())}},{key:"selectDot",value:function(t){this.lastSelectedDot&&this.lastSelectedDot.set({fill:"transparent",stroke:"#ddd",radius:5,selected:!1}),(this.lastSelectedDot=t).set({fill:"#fff0f0",stroke:"#0000ff",radius:8,selected:!0}),this.emit("focus.dot",t)}},{key:"selectCurrentPath",value:function(){var t=this.getCurrentLine().path;this.lastSelectedPath&&this.lastSelectedPath.set({shadow:null,selected:!1}),(this.lastSelectedPath=t).set({shadow:this.pathShadow,selected:!0}),this.emit("focus.path",t)}},{key:"delSelectedDot",value:function(){var t,e;this.config.editable&&(t=this.getCurrentLine(),this.lastSelectedDot&&(e=t.dots.indexOf(this.lastSelectedDot),e=t.dots.splice(e,1),e=_slicedToArray(e,1)[0],this.canvas.remove(e),this.renderLines(),this.emit("del.dot",e)))}},{key:"delCurrentLine",value:function(){var t,e=this;!this.config.editable||(t=this.getCurrentLine()).path&&t.path.selected&&(t.dots.forEach(function(t){return e.canvas.remove(t)}),this.canvas.remove(t.path),delete this.lineMap[t.id],this.emit("del.line",t),(t=Object.keys(this.lineMap)).length?this.currentLineId=t[0]:this.newEmptyLine())}},{key:"delLine",value:function(t){var e=this,i=this.lineMap[t];(1<arguments.length&&void 0!==arguments[1]&&arguments[1]||this.config.editable)&&i&&i.path&&(i.dots.forEach(function(t){return e.canvas.remove(t)}),this.canvas.remove(i.path),delete this.lineMap[t],this.emit("del.line",i),(i=Object.keys(this.lineMap)).length?this.currentLineId=i[0]:this.newEmptyLine())}},{key:"getLineStroke",value:function(){var t=this.config.lineStroke;if(Array.isArray(t)){var e=t.length;return t[(Object.keys(this.lineMap).length-1)%e]||"#fff"}return t}},{key:"renderLines",value:function(){var t,e,i,n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};0!==n.strokeWidth&&(i=n.stroke||this.getLineStroke(),t=n.strokeWidth||this.config.strokeWidth,e=this.config.editable,i={stroke:i,strokeWidth:t,opacity:this.config.pathOpacity,hoverCursor:e?"move":"pointer",fill:"",originX:"left",originY:"top",selectable:!1,evented:!e},t=this.getCurrentLine(),!e&&this.config.hasShadow&&(i.shadow=this.pathShadow),e=t.dots.map(function(t){return[t.left,t.top]}),e=this.makeSvgCurvePath.apply(this,_toConsumableArray(e)),t.path&&(Object.assign(i,{stroke:t.path.stroke,shadow:t.path.shadow,strokeWidth:t.path.strokeWidth}),this.canvas.remove(t.path)),(i=new o(e,i)).name="path",i._data=n,t.path&&(this.lastSelectedPath=i),t.path=i,this.canvas.add(i))}},{key:"makeDot",value:function(t,e){var i=this.getCurrentLine(),e=new n({left:t,top:e,strokeWidth:3,radius:5,fill:"transparent",stroke:this.config.editable?"#ddd":"transparent",evented:this.config.editable,shadow:{color:"#000",blur:2,offsetX:1,offsetY:1}});return e.hasControls=e.hasBorders=!1,e.name="dot",e.parentLine=i,this.canvas.add(e),this.emit("add.dot",e),e}},{key:"getCanvasInfo",value:function(){return this.canvas.toJSON()}},{key:"makeSvgCurvePath",value:function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];var n=e.length;if(n<2)return"";var o=e[n-1],r=e[n-2],s=Math.PI/6,a=this.config.arrowRadius,h=r[1]-o[1],l=o[0]-r[0],c=Math.atan(h/l),u=l<0?-1:1,r=o[0]-Math.cos(c+s)*a*u,h=o[1]+Math.sin(c+s)*a*u,l=o[0]-Math.cos(c-s)*a*u,u=o[1]+Math.sin(c-s)*a*u,h=[["M",r,h],["L"].concat(_toConsumableArray(o)),["L",l,u],["L",r,h],["L"].concat(_toConsumableArray(o))];if(2===n)return[["M"].concat(_toConsumableArray(e[0])),["L"].concat(_toConsumableArray(e[1]))].concat(h);for(var d=[["M"].concat(_toConsumableArray(e[0]))],f=1;f<n-1;f++){var v=(e[f][0]+e[f+1][0])/2,p=(e[f][1]+e[f+1][1])/2;d.push(["Q"].concat(_toConsumableArray(e[f]),[v,p]))}return d.push.apply(d,[["T"].concat(_toConsumableArray(o))].concat(h)),d}}]),t=d;function d(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},i=e.strokeWidth,n=void 0===i?1:i,o=e.lineStroke,r=void 0===o?"#000":o,s=e.arrowRadius,a=void 0===s?6:s,h=e.editable,l=void 0!==h&&h,c=e.formatter,i=void 0===c?function(){return""}:c,o=e.hasShadow,s=void 0!==o&&o,h=e.pathOpacity,c=void 0===h?1:h,o=e.alwaysShowTip,h=void 0!==o&&o,e=arguments[2];_classCallCheck(this,d);o=_possibleConstructorReturn(this,(d.__proto__||Object.getPrototypeOf(d)).call(this));return o.config={strokeWidth:n,lineStroke:r,arrowRadius:a,editable:l,formatter:i,hasShadow:s,pathOpacity:c,alwaysShowTip:h},o.canvas=new u(t,{selection:!1}),o.lineMap={},o.currentLineId=null,o.pathShadow={color:"#fff",blur:5,offsetX:.5,offsetY:.5},o.newEmptyLine(),o.initListeners(),e&&o.load(e),o}return t.uuid=r,i&&(e.LineDrawer=t),t});